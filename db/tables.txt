PRAGMA foreign_keys = ON;

CREATE TABLE users (
    name TEXT PRIMARY KEY,
    password TEXT NOT NULL,
    role TEXT NOT NULL, 
    uid TEXT,
    groups TEXT , 
    state INTEGER,
    timestamp_update_state INTEGER,
    vmID_assigned TEXT,
    current_alloc_id TEXT
);

CREATE TABLE resources (
    vmID TEXT PRIMARY KEY,
    nodename TEXT NOT NULL,
    ip TEXT,
    state INTEGER,
    utilization_state INTEGER,
    assigned_rdp_url TEXT,
    cem_agent_data TEXT,
    timestamp_update_state INTEGER,
    timestamp_agent_connection INTEGER,
    timestamp_update_utilization_state INTEGER
);

CREATE TABLE allocations (
    alloc_id TEXT NOT NULL,
    timestamp_start INTEGER,
    timestamp_finish INTEGER,
    resources_vmID TEXT NOT NULL REFERENCES resources (vmID) ON UPDATE CASCADE ON DELETE NO ACTION DEFERRABLE INITIALLY DEFERRED,
    username TEXT NOT NULL REFERENCES users (name) ON UPDATE CASCADE ON DELETE NO ACTION DEFERRABLE INITIALLY DEFERRED,
    PRIMARY KEY (alloc_id, resources_vmID, username)
);
